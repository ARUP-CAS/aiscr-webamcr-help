# OAI-PMH API

API v současné době nabízí službu *AMCR Data Provider*, která poskytuje metadatové záznamy z databáze AMČR, a to pomocí protokolu *OpenArchives Initiative Protocol for Metadata Harvesting* ([OAI-PMH](http://www.openarchives.org/pmh/)).

Naše implementace protokolu OAI-PMH podporuje reprezentaci metadat ve standardech:

- [Dublin Core](http://dublincore.org/) -- poskytuje část datasetu týkající se dokumentů a jejich popisu;
- ~~[CIDOC-CRM](http://www.cidoc-crm.org/) - nabízí archivovaná, volně přístupná data z AMČR ve formátu RDF v syntaxi odpovídající této ontologii;~~
- **AMČR XML** -- nativní formát, který umožňuje plné vytěžování databáze při zohlednění přístupových práv.

[Uživatelé](role.qmd) s vyšším oprávněním mohou využít své přihlašovací údaje do AMČR pro přístup k nearchivovaným či jinak chráněným záznamům. 
Aktualizace dat probíhá na denní bázi.

## Technické řešení

![OAI-PMH API a služba AMCR Data Provider](figs/api-schema.png){#fig-api width=80% align="center"}

Architektura API se skládá z 5 komponent: *AMCR Filter*, *RDF Converter*, *Scrub*, *AMCR Pass* a *AMCR Data Provider*.
Všechny komponenty jsou napsány v jazyce Java. 
~~Řešení používá open-source projekt X3ML Engine pro konverzi XML na RDF.~~

![Schéma celkového řešení API](figs/api-reseni.png){#fig-api-reseni}

![Schéma databáze s dílčími datovými sety](figs/api-sety.png){#fig-api-sety}

### Filtrace

#### Stav a přístupnost záznamu

Přístupnost záznam je ovlivněna jak [procesními stavy](procesy.qmd) daných metadatových záznamů, tak [uživatelskou rolí](role.qmd).

![Schéma přístupnosti záznamů dle uživatelských rolí](figs/api-pristupnost.png){#fig-api-pristupnost}

#### Sety

Selektivní výběr je umožněn pomocí nadefinovaných setů, viz také @fig-api-sety.

```{r}
#| label: tbl-api-sets
#| tbl-cap: "Sety"

read.csv("tabs/api-sety.csv") |>
  knitr::kable()
```

#### Datestamps

Pro dotazy `ListRecords` a `ListIdentifiers` je umožněno filtrování na základě volitelného argumentu
`datestamp` (from – od, until – do), kdy `datestamp` je vždy nejmladší z dostupných datumů.

![Specifikace nastavení `datestamp` pro jednotlivé záznamy](figs/api-datestamps.png){#fig-api-datestamps}

AMČR nepodporuje evidenci smazaných záznamů. 
Po smazání záznamu z databáze proto dojde k odstranění záznamu z API bez náhrady ve formě hlavičky smazaného záznamu (`status="deleted"`).
Některé operace se v AMČR se nemusí projevit změnou `datestamp` v API. 
Důvodem je způsob logování změn, který se váže pouze na specifické operace (změna [stavu](procesy.qmd) záznamu). 
Při využití API proto doporučujeme data pravidelně obnovovat, nebo umožnit uživateli vynucenou aktualizaci konkrétního záznamu. 
Podpora úplného sledování změn bude implementována v budoucích verzích API po provedení nutných úprav v databázi AMČR

## Příklady využití

API najdete na adrese [https://api.aiscr.cz](https://api.aiscr.cz).

[![Poster prezentující API s příklady možných requestů [@pajdla2021]](/figs/api_liseh.png){width=100% fig-align="center" #fig-api-poster}](https://gams.uni-graz.at/o:liseh.8112/PDF_STREAM)

### Přihlášení

Pokud chcete pro stahování dat používat svůj účet AMČR, je nutné přihlášení pomocí Basic access authentication. 
Protokol https zajišťuje bezpečnou komunikaci.
Způsob přihlášení se liší v každém nástroji, který je pro stahování dat používán. 
Níže jsou detailněji popsány způsoby přihlášení pro *cURL* a *Postman*.

#### cURL

cURL je nástroj skládající se ze softwarové knihovny (libcurl) a z nástroje příkazového řádku (curl) sloužících ke stahování souborů přes počítačovou síť. 
Nástroj je dostupný pro různé operační systémy Linux, macOS a Windows. 
Své uživatelské jméno a heslo je možné zadat pomocí přepínače -u.

```bash
curl -u username:password <GET request>
```

Přihlašovací údaje je nutné posílat v každém requestu.

#### Postman

Postman je multiplatformní aplikace pro vývojáře sloužící k návrhu a interakci s HTTP API. 
Uživatelské jméno a heslo lze zadávat na kartě *Autorizace*. 
V rozevírací nabídce *TYPE* zvolte možnost *Basic Auth* a stiskněte tlačítko *Odeslat*.
Přihlašovací údaje jsou poté posílány automaticky v každém requestu.

### Verbs

Dotazování v protokolu OAI-PMH je možné pomocí tzv. sloves (verbs). 
Význam jednotlivých sloves s příkladem užití jsou popsány v následujících kapitolách. 
Podrobná specifikace protokolu OAI-PMH je k dispozici [zde](http://www.openarchives.org/OAI/openarchivesprotocol.html).

#### Identify

Sloveso `Identify` se používá k získání informací o úložišti.

Dotaz: [https://api.aiscr.cz/dapro/oai?verb=Identify](https://api.aiscr.cz/dapro/oai?verb=Identify)

#### ListMetadataFormats

Sloveso `ListMetadataFormats` se používá k načtení formátů metadat dostupných z úložiště.

Dotaz: [https://api.aiscr.cz/dapro/oai?verb=ListMetadataFormats](https://api.aiscr.cz/dapro/oai?verb=ListMetadataFormats)

Odpověď:

```xml
<OAI-PMH xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd">
  <responseDate>2023-07-10T14:10:00Z</responseDate>
  <request verb="ListMetadataFormats">https://api.aiscr.cz/dapro/oai</request>
  <ListMetadataFormats>
    <metadataFormat>
      <metadataPrefix>oai_dc</metadataPrefix>
      <schema>http://www.openarchives.org/OAI/2.0/oai_dc.xsd</schema>
      <metadataNamespace>http://www.openarchives.org/OAI/2.0/oai_dc/</metadataNamespace>
    </metadataFormat>
    <metadataFormat>
      <metadataPrefix>oai_rdf</metadataPrefix>
      <schema>https://api.aiscr.cz/dapro/media/oai_rdf.xsd</schema>
      <metadataNamespace>https://api.aiscr.cz/schema/oai_rdf/</metadataNamespace>
    </metadataFormat>
     <metadataFormat>
      <metadataPrefix>oai_amcr</metadataPrefix>
      <schema>https://api.aiscr.cz/dapro/media/oai_amcr.xsd</schema>
      <metadataNamespace>https://api.aiscr.cz/schema/oai_amcr/</metadataNamespace>
    </metadataFormat>
  </ListMetadataFormats>
</OAI-PMH>
```
